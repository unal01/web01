using AspNetCoreRateLimit;
using CoreBuilder.Data;
using CoreBuilder.Factories;
using CoreBuilder.GraphQL;
using CoreBuilder.Infrastructure.Caching;
using CoreBuilder.Infrastructure.Middleware;
using CoreBuilder.Infrastructure.Security;
using CoreBuilder.Services;
using CoreBuilder.SignalR;
using CoreBuilder.Models;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Caching.Memory;
using Serilog;
using StackExchange.Redis;
using System.Text.Json.Serialization;

Log.Logger = new LoggerConfiguration()
    .ReadFrom.Configuration(new ConfigurationBuilder()
        .AddJsonFile("appsettings.json")
        .Build())
    .CreateLogger();

try
{
    Log.Information("?? CoreBuilder ba?lat?l?yor...");
    var builder = WebApplication.CreateBuilder(args);
    builder.Host.UseSerilog();

    // ???????????????????????????????????????????????????????????
    // DATABASE CONFIGURATION
    // ???????????????????????????????????????????????????????????
    var useInMemory = builder.Configuration.GetValue<bool>("UseInMemoryDatabase", true);
    
    if (useInMemory)
    {
        builder.Services.AddDbContext<AppDbContext>(options =>
            options.UseInMemoryDatabase("CoreBuilderDb"));
        Log.Information("?? Using InMemory Database");
    }
    else
    {
        builder.Services.AddDbContext<AppDbContext>(options =>
            options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));
        Log.Information("?? Using SQL Server Database");
    }

    // ???????????????????????????????????????????????????????????
    // CACHING CONFIGURATION (Redis or Memory)
    // ???????????????????????????????????????????????????????????
    var useRedis = builder.Configuration.GetValue<bool>("CacheSettings:UseRedis", false);
    var defaultExpiration = TimeSpan.FromMinutes(
        builder.Configuration.GetValue<int>("CacheSettings:DefaultExpirationMinutes", 30));

    if (useRedis)
    {
        try
        {
            var redisConnection = builder.Configuration.GetConnectionString("RedisConnection");
            var redis = ConnectionMultiplexer.Connect(redisConnection!);
            builder.Services.AddSingleton<IConnectionMultiplexer>(redis);
            builder.Services.AddSingleton<ICacheService>(sp =>
                new RedisCacheService(
                    sp.GetRequiredService<IConnectionMultiplexer>(),
                    sp.GetRequiredService<ILogger<RedisCacheService>>(),
                    defaultExpiration));
            Log.Information("?? Redis Cache enabled: {Connection}", redisConnection);
        }
        catch (Exception ex)
        {
            Log.Warning(ex, "?? Redis connection failed, falling back to Memory Cache");
            builder.Services.AddMemoryCache();
            builder.Services.AddSingleton<ICacheService>(sp =>
                new MemoryCacheService(
                    sp.GetRequiredService<IMemoryCache>(),
                    sp.GetRequiredService<ILogger<MemoryCacheService>>(),
                    defaultExpiration));
        }
    }
    else
    {
        builder.Services.AddMemoryCache();
        builder.Services.AddSingleton<ICacheService>(sp =>
            new MemoryCacheService(
                sp.GetRequiredService<IMemoryCache>(),
                sp.GetRequiredService<ILogger<MemoryCacheService>>(),
                defaultExpiration));
        Log.Information("?? Memory Cache enabled");
    }

    // ???????????????????????????????????????????????????????????
    // RATE LIMITING
    // ???????????????????????????????????????????????????????????
    builder.Services.AddDistributedMemoryCache();
    builder.Services.Configure<IpRateLimitOptions>(builder.Configuration.GetSection("IpRateLimit"));
    builder.Services.Configure<IpRateLimitPolicies>(builder.Configuration.GetSection("IpRateLimitPolicies"));
    builder.Services.AddInMemoryRateLimiting();
    builder.Services.AddSingleton<IRateLimitConfiguration, RateLimitConfiguration>();
    Log.Information("?? Rate limiting configured");

    // ???????????????????????????????????????????????????????????
    // SECURITY - JWT & CORS
    // ???????????????????????????????????????????????????????????
    builder.Services.AddJwtAuthentication(builder.Configuration);
    builder.Services.AddAuthorization();
    builder.Services.AddCorsPolicies(builder.Configuration);
    Log.Information("?? Security (JWT + CORS) configured");

    // ???????????????????????????????????????????????????????????
    // APPLICATION SERVICES
    // ???????????????????????????????????????????????????????????
    builder.Services.AddScoped<IFileStorageService, InMemoryFileStorageService>();
    builder.Services.AddScoped<SiteGenerationService>();
    builder.Services.AddScoped<ThemeService>();
    builder.Services.AddScoped<SiteService>();
    builder.Services.AddScoped<EducationSiteFactory>();
    builder.Services.AddScoped<MarketingSiteFactory>();
    builder.Services.AddScoped<GovernmentSiteFactory>();
    builder.Services.AddScoped<ExamPrepSiteFactory>();
    builder.Services.AddScoped<ImageService>();
    builder.Services.AddScoped<UserService>();
    builder.Services.AddScoped<SettingsService>();
    builder.Services.AddScoped<ContentService>();

    // ???????????????????????????????????????????????????????????
    // SIGNALR & GRAPHQL
    // ???????????????????????????????????????????????????????????
    builder.Services.AddSignalR();
    builder.Services.AddGraphQLServer()
        .AddQueryType<Query>()
        .AddMutationType<Mutation>()
        .AddProjections()
        .AddFiltering()
        .AddSorting();

    // ???????????????????????????????????????????????????????????
    // API & BLAZOR
    // ???????????????????????????????????????????????????????????
    builder.Services.AddEndpointsApiExplorer();
    builder.Services.AddSwaggerGen(c =>
    {
        c.SwaggerDoc("v1", new() { Title = "CoreBuilder API", Version = "v1" });
        c.AddSecurityDefinition("Bearer", new()
        {
            Description = "JWT Authorization header using Bearer scheme",
            Name = "Authorization",
            In = Microsoft.OpenApi.Models.ParameterLocation.Header,
            Type = Microsoft.OpenApi.Models.SecuritySchemeType.ApiKey,
            Scheme = "Bearer"
        });
        c.AddSecurityRequirement(new()
        {
            {
                new() { Reference = new() { Type = Microsoft.OpenApi.Models.ReferenceType.SecurityScheme, Id = "Bearer" } },
                Array.Empty<string>()
            }
        });
    });

    var coreAssembly = typeof(CoreBuilder.Controllers.SitesController).Assembly;
    builder.Services.AddControllers()
        .AddApplicationPart(coreAssembly)
        .AddJsonOptions(o => o.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles);

    builder.Services.AddRazorPages();
    builder.Services.AddServerSideBlazor();
    builder.Services.AddScoped(sp => new HttpClient 
    { 
        BaseAddress = new Uri(sp.GetRequiredService<Microsoft.AspNetCore.Components.NavigationManager>().BaseUri) 
    });

    // ???????????????????????????????????????????????????????????
    // HEALTH CHECKS
    // ???????????????????????????????????????????????????????????
    var healthChecksBuilder = builder.Services.AddHealthChecks();
    healthChecksBuilder.AddDbContextCheck<AppDbContext>("database");
    
    if (useRedis)
    {
        try
        {
            healthChecksBuilder.AddRedis(builder.Configuration.GetConnectionString("RedisConnection")!, "redis");
        }
        catch
        {
            Log.Warning("Redis health check skipped");
        }
    }

    var app = builder.Build();

    // ???????????????????????????????????????????????????????????
    // MIDDLEWARE PIPELINE
    // ???????????????????????????????????????????????????????????
    
    app.UseMiddleware<GlobalExceptionMiddleware>();

    if (app.Environment.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
        app.UseSwagger();
        app.UseSwaggerUI(c =>
        {
            c.SwaggerEndpoint("/swagger/v1/swagger.json", "CoreBuilder API v1");
            c.RoutePrefix = "swagger";
        });
    }
    else
    {
        app.UseHsts();
    }

    app.UseMiddleware<RequestLoggingMiddleware>();
    app.UseSerilogRequestLogging();
    app.UseIpRateLimiting();
    app.UseHttpsRedirection();
    app.UseStaticFiles();
    app.UseRouting();
    app.UseCors(CorsExtensions.DefaultPolicyName);
    app.UseAuthentication();
    app.UseAuthorization();

    app.MapControllers();
    app.MapBlazorHub();
    app.MapHub<NotificationHub>("/hubs/notifications");
    app.MapGraphQL("/graphql");
    app.MapHealthChecks("/health");
    app.MapFallbackToPage("/_Host");

    // SEED DATA
    using (var scope = app.Services.CreateScope())
    {
        var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        db.Database.EnsureCreated();

        if (!db.Themes.Any())
        {
            db.Themes.AddRange(
                new Theme { Name = "Okyanus Mavisi", PrimaryColor = "#007bff", SecondaryColor = "#6c757d", FontFamily = "Arial", IsDefault = true },
                new Theme { Name = "Orman Ye?ili", PrimaryColor = "#28a745", SecondaryColor = "#155724", FontFamily = "Verdana" },
                new Theme { Name = "Gece Modu", PrimaryColor = "#343a40", SecondaryColor = "#6c757d", FontFamily = "Segoe UI" }
            );
            await db.SaveChangesAsync();
            Log.Information("? 3 tema eklendi");
        }

        var userService = scope.ServiceProvider.GetRequiredService<UserService>();
        if (!db.Users.Any())
        {
            await userService.CreateUserAsync("admin", "admin@corebuilder.com", "Admin123!", "Admin", true);
            Log.Information("? Admin: admin / Admin123!");
        }

        Log.Information("???????????????????????????????????");
        Log.Information("?? CoreBuilder haz?r!");
        Log.Information("?? https://localhost:5001");
        Log.Information("?? admin / Admin123!");
        Log.Information("?? Cache: {CacheType}", useRedis ? "Redis" : "Memory");
        Log.Information("???????????????????????????????????");
    }

    app.Run();
}
catch (Exception ex)
{
    Log.Fatal(ex, "? Kritik hata!");
}
finally
{
    Log.CloseAndFlush();
}
