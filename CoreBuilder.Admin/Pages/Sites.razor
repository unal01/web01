@page "/sites"
@using CoreBuilder.Models
@using CoreBuilder.Services
@using CoreBuilder.Data
@inject SiteService SiteService
@inject ThemeService ThemeService
@inject SiteGenerationService SiteGenerationService

<div class="container-fluid">
    <h3 class="fw-bold text-dark mb-4">Site Yönetimi</h3>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <span class="fw-bold">Mevcut Siteler</span>
            <button class="btn btn-sm btn-primary" @onclick="AddNewSite">
                <span class="oi oi-plus me-2"></span> Yeni Site Ekle
            </button>
        </div>
        <div class="card-body">
            @if (sites.Any())
            {
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Adı</th>
                            <th>Domain</th>
                            <th>Kategori</th>
                            <th>Tema</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var site in sites)
                        {
                            <tr>
                                <td>@site.Name</td>
                                <td>@site.Domain</td>
                                <td>@site.Category</td>
                                <td>@themes.FirstOrDefault(t => t.Id == site.ThemeId)?.Name</td>
                                <td>
                                    <button class="btn btn-sm btn-info text-white">Düzenle</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteSite(site.Id)">Sil</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="alert alert-info">Henüz tanımlı site bulunmamaktadır.</div>
            }
        </div>
    </div>
</div>

<div class="@(isFormVisible ? "d-block" : "d-none") modal-overlay">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Site Oluştur</h5>
                <button type="button" class="btn-close" @onclick="CloseForm"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="@NewTenant" OnValidSubmit="SaveSite">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label for="siteName" class="form-label">Site Adı</label>
                        <InputText id="siteName" class="form-control" @bind-Value="NewTenant.Name" />
                        <ValidationMessage For="@(() => NewTenant.Name)" />
                    </div>
                    
                    <div class="mb-3">
                        <label for="domain" class="form-label">Domain (URL)</label>
                        <InputText id="domain" class="form-control" @bind-Value="NewTenant.Domain" />
                        <ValidationMessage For="@(() => NewTenant.Domain)" />
                    </div>

                    <div class="mb-3">
                        <label for="category" class="form-label">Kategori</label>
                        <InputSelect id="category" class="form-select" @bind-Value="NewTenant.Category">
                            <option value="Education">Eğitim</option>
                            <option value="Marketing">Pazarlama</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => NewTenant.Category)" />
                    </div>

                    <div class="mb-3">
                        <label for="theme" class="form-label">Tema Seçimi</label>
                        <InputSelect id="theme" class="form-select" @bind-Value="NewTenant.ThemeId">
                            <option value="@Guid.Empty">-- Tema Seçiniz --</option>
                            @foreach (var theme in themes)
                            {
                                <option value="@theme.Id">@theme.Name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => NewTenant.ThemeId)" />
                    </div>

                    <button type="submit" class="btn btn-primary mt-3">Kaydet ve Oluştur</button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Tenant> sites { get; set; } = new List<Tenant>();
    private List<Theme> themes { get; set; } = new List<Theme>();
    private Tenant NewTenant { get; set; } = new Tenant();
    private bool isFormVisible = false;

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        sites = SiteService.GetAllSites();
        themes = ThemeService.GetAllThemes();
        
        // Temaların boş olmamasını sağlamak için varsayılan tema ekleme
        if (!themes.Any())
        {
            var defaultTheme = new Theme
            {
                Id = Guid.NewGuid(),
                Name = "Default",
                PrimaryColor = "#007bff",
                SecondaryColor = "#6c757d",
                FontFamily = "Arial"
            };
            // Eğer temayı burada DB'ye kaydetme servisi varsa çağırın, yoksa sadece listeye ekleyin.
            // Bu örnekte, SiteService'e SaveTheme metodu eklenmiş olmalı.
            // Şimdilik sadece listeye ekleyelim:
            themes.Add(defaultTheme);
        }
    }

    private void AddNewSite()
    {
        NewTenant = new Tenant { Name = string.Empty, Domain = string.Empty, Category = "Education" };
        isFormVisible = true;
    }

    private void CloseForm()
    {
        isFormVisible = false;
    }

    private async Task SaveSite()
    {
        if (NewTenant.ThemeId == Guid.Empty)
        {
            // Kullanıcı tema seçmediyse, varsayılan temayı atayalım (listeden ilkini)
            NewTenant.ThemeId = themes.First().Id;
        }

        SiteService.CreateSite(NewTenant);
        
        // Varsayılan sayfaları ve modülleri oluştur
        await SiteGenerationService.GenerateDefaultContent(NewTenant);

        CloseForm();
        LoadData();
    }

    private async Task DeleteSite(Guid id)
    {
        await SiteService.DeleteSiteAsync(id);
        LoadData();
    }
}
